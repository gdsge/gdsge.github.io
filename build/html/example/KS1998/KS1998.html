<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty &mdash; GDSGE Homepage</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Mendoza (2010): Sudden Stops with Asset Price Deflation" href="../Mendoza2010/Mendoza2010.html" />
    <link rel="prev" title="Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models" href="../Huggett1997/Huggett1997.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GDSGE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lectures.html">Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rbc/rbc.html">Getting Started - A Simple RBC Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple_zlb/simple_zlb.html">Comparison with OccBin: A Simple Model with an Occasionally Binding Interest Rate ZLB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rbc/rbcIrr.html">An RBC Model with Irreversible Investment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HL1996/HL1996.html">Heaton and Lucas (1996): Incomplete Markets with Portfolio Choices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Guvenen2009/Guvenen2009.html">Guvenen (2009): Asset Pricing with Heterogeneous IES</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Bianchi2011/Bianchi2011.html">Bianchi (2011): Sudden Stops in Open Economies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../safe_assets/safe_assets.html">Barro et al. (2017): Safe Assets with Rare Disasters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandemic/GLSW2020.html">Guerrieri et al. (2022): Negative Supply Shocks That Cause Demand Shortages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_country_rbc/multi_country_rbc.html">A Multi-country Business Cycle Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ZLB/zlb.html">A New-Keynesian Model with an Occasionally Binding Interest Rate Zero Lower Bound</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/functions.html">Toolbox API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../AdditionalExamples.html">Additional Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Huggett1997/Huggett1997.html">Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-gmod-file-and-matlab-file">The gmod File and MATLAB File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Mendoza2010/Mendoza2010.html">Mendoza (2010): Sudden Stops with Asset Price Deflation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../KM1997/CaoNie2017.html">Cao and Nie (2017): Amplification and Asymmetry without Collateral Constraint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cao2018/Cao2018.html">Cao (2018): Speculation and Wealth Distribution under Beliefs Heterogeneity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cao2020/Cao2020.html">Cao (2020): Continuum versus Finite Agents in Krusell and Smith (1998)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ContributedExamples.html">Contributed Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GDSGE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../AdditionalExamples.html">Additional Examples</a> &raquo;</li>
      <li>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="krusell-and-smith-1998-heterogeneous-agent-models-with-aggregate-uncertainty">
<h1>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty<a class="headerlink" href="#krusell-and-smith-1998-heterogeneous-agent-models-with-aggregate-uncertainty" title="Permalink to this heading"></a></h1>
<p>The original <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a>
algorithm can be implemented with the toolbox, by transforming the optimization problem of the households to a system of first order conditions and complementarity-slackness conditions.</p>
<p>Though the toolbox is not designed for solving the equilibrium of this type of model directly,
since the decision problem is characterized by an equation system (the Euler equation</p>
<div class="math notranslate nohighlight">
\[u'(c_t) = \beta \mathbb{E}_t[(1-\delta+r_{t+1})u'(c_{t+1})] + \lambda_t,\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_t\)</span> is the Lagrange multiplier on the borrowing constraint, and the complementary-slackness condition, <span class="math notranslate nohighlight">\(\lambda_t k_{t+1}=0\)</span>) with state transition functions, it readily fits in the toolbox’s general framework.
One just needs an extra fixed-point loop to update the equilibrium object, which can be coded in MATLAB.
In <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a>, the equilibrium objects are the aggregate state transition coefficients.</p>
<p>The model can be solved within 100 lines of GDSGE code plus 100 lines of MATLAB code.
We present the heterogeneous-beta version of the model below.</p>
<section id="the-gmod-file-and-matlab-file">
<h2>The gmod File and MATLAB File<a class="headerlink" href="#the-gmod-file-and-matlab-file" title="Permalink to this heading"></a></h2>
<p><a class="reference download internal" download="" href="../../_downloads/ee87c3cdbbdc737ef4e2a40827b45143/ks1998.gmod"><code class="xref download docutils literal notranslate"><span class="pre">ks1998.gmod</span></code></a> (you also need the file for grid points from <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a> <a class="reference download internal" download="" href="../../_downloads/fb1c04b80a322ce3bbae19090f7c1a92/points.kgd"><code class="xref download docutils literal notranslate"><span class="pre">points.kgd</span></code></a>)</p>
<div class="highlight-GDSGE notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c">% Toolbox options</span>
<span class="linenos">  2</span>INTERP_ORDER = 4; EXTRAP_ORDER = 4;
<span class="linenos">  3</span>SIMU_RESOLVE = 0; SIMU_INTERP = 1;
<span class="linenos">  4</span>SaveFreq = inf; PrintFreq = 100; TolEq = 1e-5;
<span class="linenos">  5</span><span class="c">% Parameters</span>
<span class="linenos">  6</span><span class="k">parameters</span> alpha delta phi kMin;
<span class="linenos">  7</span>alpha = 0.36;   <span class="c">% capital share in production</span>
<span class="linenos">  8</span>delta = 0.025;  <span class="c">% depreciation rate</span>
<span class="linenos">  9</span><span class="c">% phi_k_1 phi_k_0 phi_l_1 phi_l_0; for z in {bad, good}</span>
<span class="linenos"> 10</span>phi = [
<span class="linenos"> 11</span>      0.96053     0.095014            0      -1.2228
<span class="linenos"> 12</span>      0.96072     0.099212            0      -1.1583
<span class="linenos"> 13</span>    ]&#39;;
<span class="linenos"> 14</span><span class="c">% States, use the ones as in Krusell and Smith (1998)</span>
<span class="linenos"> 15</span><span class="k">var_state</span> kbar k;
<span class="linenos"> 16</span>kbar = [11.1 11.52 11.94 12.36];
<span class="linenos"> 17</span>k = [0,1];      <span class="c">% A place holder, will be overwritten</span>
<span class="linenos"> 18</span>kMin = k(1);    <span class="c">% A place holder, will be overwritten</span>
<span class="linenos"> 19</span><span class="c">% Shock process in Krusell and Smith (1998)</span>
<span class="linenos"> 20</span><span class="k">var_shock</span> beta e unemp z z_idx;
<span class="linenos"> 21</span><span class="k">shock_num</span> = 12;
<span class="linenos"> 22</span>ez_trans = [
<span class="linenos"> 23</span>    0.5250 0.3500 0.0312 0.0938
<span class="linenos"> 24</span>    0.0389 0.8361 0.0021 0.1229
<span class="linenos"> 25</span>    0.0938 0.0312 0.2917 0.5833
<span class="linenos"> 26</span>    0.0091 0.1159 0.0243 0.8507
<span class="linenos"> 27</span>    ];
<span class="linenos"> 28</span>beta_trans = [
<span class="linenos"> 29</span>    0.9950 0.0050 0.0000
<span class="linenos"> 30</span>    0.000625 0.99875 0.000625
<span class="linenos"> 31</span>    0.0000 0.0050 0.9950
<span class="linenos"> 32</span>    ];
<span class="linenos"> 33</span><span class="k">shock_trans</span> = kron(ez_trans,beta_trans);
<span class="linenos"> 34</span>z_idx_grid = [0, 1];
<span class="linenos"> 35</span>z_grid = [0.99, 1.01];
<span class="linenos"> 36</span>e_grid = [0.00, 0.3271];
<span class="linenos"> 37</span>unemp_grid = [0.07, 0.00];  <span class="c">% unemployement transfer</span>
<span class="linenos"> 38</span>beta_grid = [0.9858 0.9894 0.9930];
<span class="linenos"> 39</span>[beta,e,z] = ndgrid(beta_grid,e_grid,z_grid);
<span class="linenos"> 40</span>[~,unemp,z_idx] = ndgrid(beta_grid,unemp_grid,z_idx_grid);
<span class="linenos"> 41</span>beta=beta(:); e = e(:); unemp = unemp(:);
<span class="linenos"> 42</span>z = z(:); z_idx = z_idx(:);
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="c">% State transition functions</span>
<span class="linenos"> 45</span><span class="k">var_interp</span> Evp_interp Ev_interp;
<span class="linenos"> 46</span><span class="k">initial</span> Evp_interp 1./(k+e+unemp-kMin);
<span class="linenos"> 47</span><span class="k">initial</span> Ev_interp log(k+e+unemp-kMin);
<span class="linenos"> 48</span><span class="c">% Update</span>
<span class="linenos"> 49</span>Evp_interp = <span class="k">shock_trans</span> * vp;
<span class="linenos"> 50</span>Ev_interp = <span class="k">shock_trans</span> * v;
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="c">% Tensor</span>
<span class="linenos"> 53</span><span class="k">var_tensor</span> kbar_next lbar Y r w budget;
<span class="linenos"> 54</span><span class="c">% Forecasting rule</span>
<span class="linenos"> 55</span>kbar_next = exp(log(kbar).*phi(z_idx*4+1) + phi(z_idx*4+2));
<span class="linenos"> 56</span>lbar = exp(log(kbar).*phi(z_idx*4+3) + phi(z_idx*4+4));
<span class="linenos"> 57</span><span class="c">% Interst rate and wage</span>
<span class="linenos"> 58</span>Y = z .* kbar.^alpha .* lbar.^(1-alpha)
<span class="linenos"> 59</span>r = alpha*Y./kbar - delta;
<span class="linenos"> 60</span>w = (1-alpha)*Y./lbar;
<span class="linenos"> 61</span>budget = k.*(1+r) + e.*w + unemp;
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="c">% Endogenous variables</span>
<span class="linenos"> 64</span><span class="k">var_policy</span> k_next lambda;
<span class="linenos"> 65</span><span class="k">inbound</span> k_next kMin budget;
<span class="linenos"> 66</span><span class="k">inbound</span> lambda 0 1.0;
<span class="linenos"> 67</span><span class="c">% Other variables out of the block</span>
<span class="linenos"> 68</span><span class="k">var_aux</span> c vp v l;
<span class="linenos"> 69</span><span class="c">% Used in simulation</span>
<span class="linenos"> 70</span><span class="k">var_output</span> c k_next l;
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="k">model;</span>
<span class="linenos"> 73</span>  c = budget - k_next;
<span class="linenos"> 74</span>  u_prime = 1/c;
<span class="linenos"> 75</span>  [Evp_future,Ev_future] = <span class="k">GDSGE_INTERP_VEC</span>(shock,kbar_next,k_next);
<span class="linenos"> 76</span>  Evp_future = Evp_future;
<span class="linenos"> 77</span>  euler_residual = -1 + beta*Evp_future/u_prime + lambda;
<span class="linenos"> 78</span>  vp = (1+r)*u_prime;
<span class="linenos"> 79</span>  v = log(c) + beta*Ev_future;
<span class="linenos"> 80</span>  l = e;
<span class="linenos"> 81</span>  <span class="k">equations;</span>
<span class="linenos"> 82</span>    euler_residual;
<span class="linenos"> 83</span>    lambda*(k_next-kMin);
<span class="linenos"> 84</span>  <span class="k">end;</span>
<span class="linenos"> 85</span><span class="k">end;</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="k">simulate;</span>
<span class="linenos"> 88</span>  <span class="k">num_periods</span> = 11000;
<span class="linenos"> 89</span>  <span class="k">num_samples</span> = 10000;
<span class="linenos"> 90</span>  <span class="k">initial</span> k 1;
<span class="linenos"> 91</span>  <span class="k">initial</span> kbar 1;
<span class="linenos"> 92</span>  <span class="k">initial</span> shock 1;
<span class="linenos"> 93</span>  <span class="k">var_simu</span> c l;
<span class="linenos"> 94</span>  k&#39; = k_next;
<span class="linenos"> 95</span>  kbar&#39; = k_next;    <span class="c">% A place holder</span>
<span class="linenos"> 96</span><span class="k">end;</span>
<span class="linenos"> 97</span>post_simulate_iter;
<span class="linenos"> 98</span>  SimuRslt.kbar(:,GDSGE_t+1) = mean(SimuRslt.k(:,GDSGE_t+1));
<span class="linenos"> 99</span>  SimuRslt.lbar(:,GDSGE_t) = mean(SimuRslt.l(:,GDSGE_t));
<span class="linenos">100</span><span class="k">end;</span>
</pre></div>
</div>
<p>The MATLAB file that calls the toolbox codes and manually update equilibrium objects <a class="reference download internal" download="" href="../../_downloads/ead22ec2559b002c22988f3564d7f648/main.m"><code class="xref download docutils literal notranslate"><span class="pre">main.m</span></code></a></p>
<div class="highlight-MATLAB notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c">%% Solve the warm-up problems</span><span class="w"></span>
<span class="linenos">  2</span><span class="n">options</span><span class="p">.</span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">csvread</span><span class="p">(</span><span class="s">&#39;points.kgd&#39;</span><span class="p">);</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">kMin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">k</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  3</span><span class="n">IterRslt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">iter_ks1998</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="c">%% Generate random numbers</span><span class="w"></span>
<span class="linenos">  6</span><span class="c">% Parameters</span><span class="w"></span>
<span class="linenos">  7</span><span class="n">num_periods</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">11000</span><span class="p">;</span><span class="w"></span>
<span class="linenos">  8</span><span class="n">num_samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="c">% Need around 8GB to run the simulation</span><span class="w"></span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="c">% Transition matrix for aggregate shocks</span><span class="w"></span>
<span class="linenos"> 11</span><span class="n">shock_trans</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">IterRslt</span><span class="p">.</span><span class="n">shock_trans</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 12</span><span class="c">% Reduction along the z dimension (beta,e,z) -&gt; (beta&#39;,e&#39;,z&#39;)</span><span class="w"></span>
<span class="linenos"> 13</span><span class="n">shock_trans_zp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans</span><span class="p">,[</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 14</span><span class="n">z_trans</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans_zp</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,:),[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c">% Aggregate shock</span><span class="w"></span>
<span class="linenos"> 17</span><span class="nb">rng</span><span class="p">(</span><span class="mi">0729</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 18</span><span class="n">z_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen_discrete_markov_rn</span><span class="p">(</span><span class="n">z_trans</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_periods</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 19</span><span class="c">% Idiosyncratic shock conditional on aggregate shock</span><span class="w"></span>
<span class="linenos"> 20</span><span class="c">% Permute to (beta,e) -&gt; (beta&#39;,e&#39;) | (z,z&#39;)</span><span class="w"></span>
<span class="linenos"> 21</span><span class="n">shock_trans_conditional_on_z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">permute</span><span class="p">(</span><span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans</span><span class="p">,[</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">]),[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">z_trans</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="linenos"> 22</span><span class="n">ind_shock_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen_discrete_markov_rn_with_agg</span><span class="p">(</span><span class="n">shock_trans_conditional_on_z</span><span class="p">,</span><span class="w"> </span><span class="n">num_samples</span><span class="p">,</span><span class="w"> </span><span class="n">num_periods</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">z_idx</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">num_samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">num_samples</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 25</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">GEN_SHOCK_START_PERIOD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">num_periods</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 26</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">shock</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ind_shock_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 27</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">11</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 28</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">kbar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">11</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 29</span><span class="n">simuOptions</span><span class="p">.</span><span class="n">EnforceSimuStateInbound</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="c">%% Iterate transition coefficients phi</span><span class="w"></span>
<span class="linenos"> 32</span><span class="n">phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="linenos"> 33</span><span class="w">      </span><span class="mf">0.96053</span><span class="w">     </span><span class="mf">0.095014</span><span class="w">            </span><span class="mi">0</span><span class="w">      </span><span class="o">-</span><span class="mf">1.2228</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">      </span><span class="mf">0.96072</span><span class="w">     </span><span class="mf">0.099212</span><span class="w">            </span><span class="mi">0</span><span class="w">      </span><span class="o">-</span><span class="mf">1.1583</span><span class="w"></span>
<span class="linenos"> 35</span><span class="w">    </span><span class="p">]</span><span class="o">&#39;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 36</span><span class="n">metric_phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">inf</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 37</span><span class="n">tol_phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 38</span><span class="n">update_speed</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 39</span><span class="n">iter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 40</span><span class="k">while</span><span class="w"> </span><span class="n">metric_phi</span><span class="o">&gt;</span><span class="n">tol_phi</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">phi</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">WarmUp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">IterRslt</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 43</span><span class="w">    </span><span class="n">IterRslt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">iter_ks1998</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 44</span><span class="w">    </span><span class="n">SimuRslt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">simulate_ks1998</span><span class="p">(</span><span class="n">IterRslt</span><span class="p">,</span><span class="n">simuOptions</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">    </span>
<span class="linenos"> 46</span><span class="w">    </span><span class="c">% Collect samples and run regression</span><span class="w"></span>
<span class="linenos"> 47</span><span class="w">    </span><span class="n">burnPeriods</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 48</span><span class="w">    </span><span class="n">periodIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">num_periods</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 49</span><span class="w">    </span><span class="n">r2_z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">    </span><span class="n">rmse_z</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 51</span><span class="w">    </span><span class="n">phi_new</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">phi</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 52</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i_z</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 53</span><span class="w">        </span><span class="n">periodSet</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">periodIndex</span><span class="p">(</span><span class="n">z_idx</span><span class="o">==</span><span class="n">i_z</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">periodIndex</span><span class="o">&gt;</span><span class="n">burnPeriods</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">        </span><span class="n">sample_lbar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">lbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 55</span><span class="w">        </span><span class="n">sample_kbar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">kbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 56</span><span class="w">        </span><span class="n">sample_kbar_next</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">kbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">        </span><span class="n">mdl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fitlm</span><span class="p">(</span><span class="nb">log</span><span class="p">(</span><span class="n">sample_kbar</span><span class="p">),</span><span class="nb">log</span><span class="p">(</span><span class="n">sample_kbar_next</span><span class="p">));</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">        </span>
<span class="linenos"> 59</span><span class="w">        </span><span class="n">phi_new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mdl</span><span class="p">.</span><span class="n">Coefficients</span><span class="p">.</span><span class="n">Estimate</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 60</span><span class="w">        </span><span class="n">phi_new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mdl</span><span class="p">.</span><span class="n">Coefficients</span><span class="p">.</span><span class="n">Estimate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 61</span><span class="w">        </span><span class="n">phi_new</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="nb">mean</span><span class="p">(</span><span class="n">sample_lbar</span><span class="p">));</span><span class="w"></span>
<span class="linenos"> 62</span><span class="w">        </span><span class="n">r2_z</span><span class="p">(</span><span class="n">i_z</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mdl</span><span class="p">.</span><span class="n">Rsquared</span><span class="p">.</span><span class="n">Ordinary</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 63</span><span class="w">        </span><span class="n">rmse_z</span><span class="p">(</span><span class="n">i_z</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mdl</span><span class="p">.</span><span class="n">RMSE</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">    </span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">metric_phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">(:)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi_new</span><span class="p">(:)));</span><span class="w"></span>
<span class="linenos"> 68</span><span class="w">    </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;iter, metric_phi: %d, %g\n&#39;</span><span class="p">,</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="n">metric_phi</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c">% Update</span><span class="w"></span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">phi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">phi_new</span><span class="o">*</span><span class="n">update_speed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">update_speed</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 71</span><span class="k">end</span><span class="w"></span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="c">%% Post analysis</span><span class="w"></span>
<span class="linenos"> 74</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Converged transition coefficients (phi_k_1 phi_k_0 phi_l_1 phi_l_0):&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 75</span><span class="nb">disp</span><span class="p">(</span><span class="n">phi</span><span class="o">&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 76</span><span class="c">% fraction negative wealth</span><span class="w"></span>
<span class="linenos"> 77</span><span class="nb">sum</span><span class="p">(</span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">num_periods</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">num_periods</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 78</span><span class="c">% Gini coefficients</span><span class="w"></span>
<span class="linenos"> 79</span><span class="n">samplePeriods</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">num_periods</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 80</span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">samplePeriods</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 81</span><span class="c">% ginicoeff(k(k&gt;=0)) % Uncomment this to calculate gini if you have ginicoeff routine</span><span class="w"></span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="c">%%%%%%%%%%%%%%% MAIN ENDS HERE %%%%%%%%%%%%%%%%%%</span><span class="w"></span>
<span class="linenos"> 84</span><span class="k">function</span><span class="w"> </span>shock<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">gen_discrete_markov_rn_with_agg</span><span class="p">(</span>trans,numPaths,lenPath,initShock,aggIdx<span class="p">)</span><span class="w"></span>
<span class="linenos"> 85</span><span class="c">% Generate idiosyncratic shocks conditional on aggregate shocks</span><span class="w"></span>
<span class="linenos"> 86</span><span class="n">numStates</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 87</span><span class="n">shock</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">numPaths</span><span class="p">,</span><span class="n">lenPath</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 88</span><span class="n">shock</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">initShock</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 89</span><span class="n">cumTrans</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cumsum</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 90</span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">lenPath</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 91</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">numStates</span><span class="w"></span>
<span class="linenos"> 92</span><span class="w">        </span><span class="c">% Find samples that has shock j</span><span class="w"></span>
<span class="linenos"> 93</span><span class="w">        </span><span class="n">idxOfShockJ</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">shock</span><span class="p">(:,</span><span class="n">t</span><span class="p">)</span><span class="o">==</span><span class="nb">j</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">        </span><span class="c">% Fill in numbers based on distribution weights</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">        </span><span class="n">un</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">rand</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">idxOfShockJ</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">        </span><span class="c">% Look up trans_j</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">        </span><span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="n">shock</span><span class="p">(</span><span class="n">idxOfShockJ</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">histc</span><span class="p">(</span><span class="n">un</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="n">cumTrans</span><span class="p">(</span><span class="nb">j</span><span class="p">,:,</span><span class="n">aggIdx</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="n">aggIdx</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))]);</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="linenos"> 99</span><span class="k">end</span><span class="w"></span>
<span class="linenos">100</span><span class="k">end</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Huggett1997/Huggett1997.html" class="btn btn-neutral float-left" title="Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Mendoza2010/Mendoza2010.html" class="btn btn-neutral float-right" title="Mendoza (2010): Sudden Stops with Asset Price Deflation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Dan Cao, Wenlan Luo, and Guangyu Nie.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>