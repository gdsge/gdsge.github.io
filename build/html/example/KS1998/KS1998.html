

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty &mdash; GDSGE Homepage</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Mendoza (2010): Sudden Stops with Asset Price Deflation" href="../Mendoza2010/Mendoza2010.html" />
    <link rel="prev" title="Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models" href="../Huggett1997/Huggett1997.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> GDSGE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lectures.html">Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rbc/rbc.html">Getting Started - A Simple RBC Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rbc/rbcIrr.html">An RBC Model with Irreversible Investment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HL1996/HL1996.html">Heaton and Lucas (1996): Incomplete Markets with Portfolio Choices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Guvenen2009/Guvenen2009.html">Guvenen (2009): Asset Pricing with Heterogeneous IES</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Bianchi2011/Bianchi2011.html">Bianchi (2011): Sudden Stops in Open Economies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../safe_assets/safe_assets.html">Barro et al. (2017): Safe Assets with Rare Disasters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandemic/GLSW2020.html">Guerrieri et al. (2020): Negative Supply Shocks That Cause Demand Shortages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/functions.html">Toolbox API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../AdditionalExamples.html">Additional Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Huggett1997/Huggett1997.html">Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-gmod-file-and-matlab-file">The gmod File and MATLAB File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Mendoza2010/Mendoza2010.html">Mendoza (2010): Sudden Stops with Asset Price Deflation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../KM1997/CaoNie2017.html">Cao and Nie (2017): Amplification and Asymmetry without Collateral Constraint</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cao2018/Cao2018.html">Cao (2018): Speculation and Wealth Distribution under Beliefs Heterogeneity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Cao2020/Cao2020.html">Cao (2020): Continuum versus Finite Agents in Krusell and Smith (1998)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ContributedExamples.html">Contributed Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GDSGE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../AdditionalExamples.html">Additional Examples</a> &raquo;</li>
        
      <li>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="krusell-and-smith-1998-heterogeneous-agent-models-with-aggregate-uncertainty">
<h1>Krusell and Smith (1998): Heterogeneous Agent Models with Aggregate Uncertainty<a class="headerlink" href="#krusell-and-smith-1998-heterogeneous-agent-models-with-aggregate-uncertainty" title="Permalink to this headline">¶</a></h1>
<p>The original <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a>
algorithm can be implemented with the toolbox, by transforming the optimization problem of the households to a system of first order conditions and complementarity-slackness conditions.</p>
<p>Though the toolbox is not designed for solving the equilibrium of this type of model directly,
since the decision problem is characterized by an equation system (the Euler equation</p>
<div class="math notranslate nohighlight">
\[u'(c_t) = \beta \mathbb{E}_t[(1-\delta+r_{t+1})u'(c_{t+1})] + \lambda_t,\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_t\)</span> is the Lagrange multiplier on the borrowing constraint, and the complementary-slackness condition, <span class="math notranslate nohighlight">\(\lambda_t k_{t+1}=0\)</span>) with state transition functions, it readily fits in the toolbox’s general framework.
One just needs an extra fixed-point loop to update the equilibrium object, which can be coded in MATLAB.
In <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a>, the equilibrium objects are the aggregate state transition coefficients.</p>
<p>The model can be solved within 100 lines of GDSGE code plus 100 lines of MATLAB code.
We present the heterogeneous-beta version of the model below.</p>
<div class="section" id="the-gmod-file-and-matlab-file">
<h2>The gmod File and MATLAB File<a class="headerlink" href="#the-gmod-file-and-matlab-file" title="Permalink to this headline">¶</a></h2>
<p><a class="reference download internal" download="" href="../../_downloads/8be8da794cb82c3ef9e54640dbbcaccd/ks1998.gmod"><code class="xref download docutils literal notranslate"><span class="pre">ks1998.gmod</span></code></a> (you also need the file for grid points from <a class="reference external" href="https://www.jstor.org/stable/10.1086/250034">Krusell and Smith (1998)</a> <a class="reference download internal" download="" href="../../_downloads/b76ee942352ca82eebb17defa0587b25/points.kgd"><code class="xref download docutils literal notranslate"><span class="pre">points.kgd</span></code></a>)</p>
<div class="highlight-GDSGE notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">% Toolbox options</span>
INTERP_ORDER = 4; EXTRAP_ORDER = 4;
SIMU_RESOLVE = 0; SIMU_INTERP = 1;
SaveFreq = inf; PrintFreq = 100; TolEq = 1e-5;
<span class="c">% Parameters</span>
<span class="k">parameters</span> alpha delta phi kMin;
alpha = 0.36;   <span class="c">% capital share in production</span>
delta = 0.025;  <span class="c">% depreciation rate</span>
<span class="c">% phi_k_1 phi_k_0 phi_l_1 phi_l_0; for z in {bad, good}</span>
phi = [
      0.96053     0.095014            0      -1.2228
      0.96072     0.099212            0      -1.1583
    ]&#39;;
<span class="c">% States, use the ones as in Krusell and Smith (1998)</span>
<span class="k">var_state</span> kbar k;
kbar = [11.1 11.52 11.94 12.36];
k = [0,1];      <span class="c">% A place holder, will be overwritten</span>
kMin = k(1);    <span class="c">% A place holder, will be overwritten</span>
<span class="c">% Shock process in Krusell and Smith (1998)</span>
<span class="k">var_shock</span> beta e unemp z z_idx;
<span class="k">shock_num</span> = 12;
ez_trans = [
    0.5250 0.3500 0.0312 0.0938
    0.0389 0.8361 0.0021 0.1229
    0.0938 0.0312 0.2917 0.5833
    0.0091 0.1159 0.0243 0.8507
    ];
beta_trans = [
    0.9950 0.0050 0.0000
    0.000625 0.99875 0.000625
    0.0000 0.0050 0.9950
    ];
<span class="k">shock_trans</span> = kron(ez_trans,beta_trans);
z_idx_grid = [0, 1];
z_grid = [0.99, 1.01];
e_grid = [0.00, 0.3271];
unemp_grid = [0.07, 0.00];  <span class="c">% unemployement transfer</span>
beta_grid = [0.9858 0.9894 0.9930];
[beta,e,z] = ndgrid(beta_grid,e_grid,z_grid);
[~,unemp,z_idx] = ndgrid(beta_grid,unemp_grid,z_idx_grid);
beta=beta(:); e = e(:); unemp = unemp(:);
z = z(:); z_idx = z_idx(:);

<span class="c">% State transition functions</span>
<span class="k">var_interp</span> Evp_interp Ev_interp;
<span class="k">initial</span> Evp_interp 1./(k+e+unemp-kMin);
<span class="k">initial</span> Ev_interp log(k+e+unemp-kMin);
<span class="c">% Update</span>
Evp_interp = <span class="k">shock_trans</span> * vp;
Ev_interp = <span class="k">shock_trans</span> * v;

<span class="c">% Tensor</span>
<span class="k">var_tensor</span> kbar_next lbar Y r w budget;
<span class="c">% Forecasting rule</span>
kbar_next = exp(log(kbar).*phi(z_idx*4+1) + phi(z_idx*4+2));
lbar = exp(log(kbar).*phi(z_idx*4+3) + phi(z_idx*4+4));
<span class="c">% Interst rate and wage</span>
Y = z .* kbar.^alpha .* lbar.^(1-alpha)
r = alpha*Y./kbar - delta;
w = (1-alpha)*Y./lbar;
budget = k.*(1+r) + e.*w + unemp;

<span class="c">% Endogenous variables</span>
<span class="k">var_policy</span> k_next lambda;
<span class="k">inbound</span> k_next kMin budget;
<span class="k">inbound</span> lambda 0 1.0;
<span class="c">% Other variables out of the block</span>
<span class="k">var_aux</span> c vp v l;
<span class="c">% Used in simulation</span>
<span class="k">var_output</span> c k_next l;

<span class="k">model;</span>
  c = budget - k_next;
  u_prime = 1/c;
  [Evp_future,Ev_future] = GDSGE_INTERP_VEC(shock,kbar_next,k_next);
  Evp_future = Evp_future;
  euler_residual = -1 + beta*Evp_future/u_prime + lambda;
  vp = (1+r)*u_prime;
  v = log(c) + beta*Ev_future;
  l = e;
  <span class="k">equations;</span>
    euler_residual;
    lambda*(k_next-kMin);
  <span class="k">end;</span>
<span class="k">end;</span>

<span class="k">simulate;</span>
  <span class="k">num_periods</span> = 11000;
  <span class="k">num_samples</span> = 10000;
  <span class="k">initial</span> k 1;
  <span class="k">initial</span> kbar 1;
  <span class="k">initial</span> shock 1;
  <span class="k">var_simu</span> c l;
  k&#39; = k_next;
  kbar&#39; = k_next;    <span class="c">% A place holder</span>
<span class="k">end;</span>
post_simulate_iter;
  SimuRslt.kbar(:,GDSGE_t+1) = mean(SimuRslt.k(:,GDSGE_t+1));
  SimuRslt.lbar(:,GDSGE_t) = mean(SimuRslt.l(:,GDSGE_t));
<span class="k">end;</span>
</pre></div>
</td></tr></table></div>
<p>The MATLAB file that calls the toolbox codes and manually update equilibrium objects <a class="reference download internal" download="" href="../../_downloads/3b387d06660f615c56d4c603d549b9ac/main.m"><code class="xref download docutils literal notranslate"><span class="pre">main.m</span></code></a></p>
<div class="highlight-MATLAB notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">%% Solve the warm-up problems</span>
<span class="n">options</span><span class="p">.</span><span class="n">k</span> <span class="p">=</span> <span class="n">csvread</span><span class="p">(</span><span class="s">&#39;points.kgd&#39;</span><span class="p">);</span> <span class="n">options</span><span class="p">.</span><span class="n">kMin</span> <span class="p">=</span> <span class="n">options</span><span class="p">.</span><span class="n">k</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">IterRslt</span> <span class="p">=</span> <span class="n">iter_ks1998</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>

<span class="c">%% Generate random numbers</span>
<span class="c">% Parameters</span>
<span class="n">num_periods</span> <span class="p">=</span> <span class="mi">11000</span><span class="p">;</span>
<span class="n">num_samples</span> <span class="p">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c">% Need around 8GB to run the simulation</span>

<span class="c">% Transition matrix for aggregate shocks</span>
<span class="n">shock_trans</span> <span class="p">=</span> <span class="n">IterRslt</span><span class="p">.</span><span class="n">shock_trans</span><span class="p">;</span>
<span class="c">% Reduction along the z dimension (beta,e,z) -&gt; (beta&#39;,e&#39;,z&#39;)</span>
<span class="n">shock_trans_zp</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans</span><span class="p">,[</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span><span class="mi">3</span><span class="p">);</span>
<span class="n">z_trans</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans_zp</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,:),[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span>

<span class="c">% Aggregate shock</span>
<span class="n">rng</span><span class="p">(</span><span class="mi">0729</span><span class="p">);</span>
<span class="n">z_idx</span> <span class="p">=</span> <span class="n">gen_discrete_markov_rn</span><span class="p">(</span><span class="n">z_trans</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_periods</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="c">% Idiosyncratic shock conditional on aggregate shock</span>
<span class="c">% Permute to (beta,e) -&gt; (beta&#39;,e&#39;) | (z,z&#39;)</span>
<span class="n">shock_trans_conditional_on_z</span> <span class="p">=</span> <span class="nb">permute</span><span class="p">(</span><span class="nb">reshape</span><span class="p">(</span><span class="n">shock_trans</span><span class="p">,[</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">]),[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span> <span class="o">./</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">z_trans</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">ind_shock_idx</span> <span class="p">=</span> <span class="n">gen_discrete_markov_rn_with_agg</span><span class="p">(</span><span class="n">shock_trans_conditional_on_z</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">num_periods</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">z_idx</span><span class="p">);</span>

<span class="n">simuOptions</span><span class="p">.</span><span class="n">num_samples</span> <span class="p">=</span> <span class="n">num_samples</span><span class="p">;</span>
<span class="n">simuOptions</span><span class="p">.</span><span class="n">GEN_SHOCK_START_PERIOD</span> <span class="p">=</span> <span class="n">num_periods</span><span class="p">;</span>
<span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">shock</span> <span class="p">=</span> <span class="n">ind_shock_idx</span> <span class="o">+</span> <span class="p">(</span><span class="n">z_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">;</span>
<span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">k</span> <span class="p">=</span> <span class="mi">11</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">simuOptions</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="n">kbar</span> <span class="p">=</span> <span class="mi">11</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">simuOptions</span><span class="p">.</span><span class="n">EnforceSimuStateInbound</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c">%% Iterate transition coefficients phi</span>
<span class="n">phi</span> <span class="p">=</span> <span class="p">[</span>
      <span class="mf">0.96053</span>     <span class="mf">0.095014</span>            <span class="mi">0</span>      <span class="o">-</span><span class="mf">1.2228</span>
      <span class="mf">0.96072</span>     <span class="mf">0.099212</span>            <span class="mi">0</span>      <span class="o">-</span><span class="mf">1.1583</span>
    <span class="p">]</span><span class="o">&#39;</span><span class="p">;</span>
<span class="n">metric_phi</span> <span class="p">=</span> <span class="nb">inf</span><span class="p">;</span>
<span class="n">tol_phi</span> <span class="p">=</span> <span class="mf">1e-4</span><span class="p">;</span>
<span class="n">update_speed</span> <span class="p">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">iter</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">while</span> <span class="s">metric_phi&gt;tol_phi</span>
    <span class="n">options</span><span class="p">.</span><span class="n">phi</span> <span class="p">=</span> <span class="n">phi</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">WarmUp</span> <span class="p">=</span> <span class="n">IterRslt</span><span class="p">;</span>
    <span class="n">IterRslt</span> <span class="p">=</span> <span class="n">iter_ks1998</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
    <span class="n">SimuRslt</span> <span class="p">=</span> <span class="n">simulate_ks1998</span><span class="p">(</span><span class="n">IterRslt</span><span class="p">,</span><span class="n">simuOptions</span><span class="p">);</span>
    
    <span class="c">% Collect samples and run regression</span>
    <span class="n">burnPeriods</span> <span class="p">=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">periodIndex</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">num_periods</span><span class="p">;</span>
    <span class="n">r2_z</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">rmse_z</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">phi_new</span> <span class="p">=</span> <span class="n">phi</span><span class="p">;</span>
    <span class="n">for</span> <span class="s">i_z=1:2</span>
        <span class="n">periodSet</span> <span class="p">=</span> <span class="n">periodIndex</span><span class="p">(</span><span class="n">z_idx</span><span class="o">==</span><span class="n">i_z</span> <span class="o">&amp;</span> <span class="n">periodIndex</span><span class="o">&gt;</span><span class="n">burnPeriods</span><span class="p">);</span>
        <span class="n">sample_lbar</span> <span class="p">=</span> <span class="n">SimuRslt</span><span class="p">.</span><span class="n">lbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="p">);</span>
        <span class="n">sample_kbar</span> <span class="p">=</span> <span class="n">SimuRslt</span><span class="p">.</span><span class="n">kbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="p">);</span>
        <span class="n">sample_kbar_next</span> <span class="p">=</span> <span class="n">SimuRslt</span><span class="p">.</span><span class="n">kbar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">periodSet</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">mdl</span> <span class="p">=</span> <span class="n">fitlm</span><span class="p">(</span><span class="nb">log</span><span class="p">(</span><span class="n">sample_kbar</span><span class="p">),</span><span class="nb">log</span><span class="p">(</span><span class="n">sample_kbar_next</span><span class="p">));</span>
        
        <span class="n">phi_new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span> <span class="p">=</span> <span class="n">mdl</span><span class="p">.</span><span class="n">Coefficients</span><span class="p">.</span><span class="n">Estimate</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">phi_new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span> <span class="p">=</span> <span class="n">mdl</span><span class="p">.</span><span class="n">Coefficients</span><span class="p">.</span><span class="n">Estimate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">phi_new</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">i_z</span><span class="p">)</span> <span class="p">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_lbar</span><span class="p">));</span>
        <span class="n">r2_z</span><span class="p">(</span><span class="n">i_z</span><span class="p">)</span> <span class="p">=</span> <span class="n">mdl</span><span class="p">.</span><span class="n">Rsquared</span><span class="p">.</span><span class="n">Ordinary</span><span class="p">;</span>
        <span class="n">rmse_z</span><span class="p">(</span><span class="n">i_z</span><span class="p">)</span> <span class="p">=</span> <span class="n">mdl</span><span class="p">.</span><span class="n">RMSE</span><span class="p">;</span>
    <span class="n">end</span>
    
    <span class="s">iter</span> <span class="p">=</span> <span class="n">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">metric_phi</span> <span class="p">=</span> <span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">(:)</span> <span class="o">-</span> <span class="n">phi_new</span><span class="p">(:)));</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="s">&#39;iter, metric_phi: %d, %g\n&#39;</span><span class="p">,</span><span class="n">iter</span><span class="p">,</span> <span class="n">metric_phi</span><span class="p">);</span>
    <span class="c">% Update</span>
    <span class="n">phi</span> <span class="p">=</span> <span class="n">phi_new</span><span class="o">*</span><span class="n">update_speed</span> <span class="o">+</span> <span class="n">phi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">update_speed</span><span class="p">);</span>
<span class="n">end</span>

<span class="s">%%</span> <span class="s">Post</span> <span class="s">analysis</span>
<span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Converged transition coefficients (phi_k_1 phi_k_0 phi_l_1 phi_l_0):&#39;</span><span class="p">);</span>
<span class="nb">disp</span><span class="p">(</span><span class="n">phi</span><span class="o">&#39;</span><span class="p">)</span>
<span class="c">% fraction negative wealth</span>
<span class="n">sum</span><span class="p">(</span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">num_periods</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">numel</span><span class="p">(</span><span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">num_periods</span><span class="p">))</span>
<span class="c">% Gini coefficients</span>
<span class="n">samplePeriods</span> <span class="p">=</span> <span class="n">num_periods</span><span class="p">;</span>
<span class="n">k</span> <span class="p">=</span> <span class="n">SimuRslt</span><span class="p">.</span><span class="n">k</span><span class="p">(:,</span><span class="n">samplePeriods</span><span class="p">);</span>
<span class="c">% ginicoeff(k(k&gt;=0)) % Uncomment this to calculate gini if you have ginicoeff routine</span>

<span class="c">%%%%%%%%%%%%%%% MAIN ENDS HERE %%%%%%%%%%%%%%%%%%</span>
<span class="k">function</span><span class="w"> </span>shock <span class="p">=</span><span class="w"> </span><span class="nf">gen_discrete_markov_rn_with_agg</span><span class="p">(</span>trans,numPaths,lenPath,initShock,aggIdx<span class="p">)</span><span class="w"></span>
<span class="c">% Generate idiosyncratic shocks conditional on aggregate shocks</span>
<span class="n">numStates</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">shock</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">numPaths</span><span class="p">,</span><span class="n">lenPath</span><span class="p">);</span>
<span class="n">shock</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">initShock</span><span class="p">;</span>
<span class="n">cumTrans</span> <span class="p">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">for</span> <span class="s">t=1:lenPath-1</span>
    <span class="n">for</span> <span class="s">j=1:numStates</span>
        <span class="c">% Find samples that has shock j</span>
        <span class="n">idxOfShockJ</span> <span class="p">=</span> <span class="nb">find</span><span class="p">(</span><span class="n">shock</span><span class="p">(:,</span><span class="n">t</span><span class="p">)</span><span class="o">==</span><span class="nb">j</span><span class="p">);</span>
        <span class="c">% Fill in numbers based on distribution weights</span>
        <span class="n">un</span> <span class="p">=</span> <span class="n">rand</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">idxOfShockJ</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
        <span class="c">% Look up trans_j</span>
        <span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="n">shock</span><span class="p">(</span><span class="n">idxOfShockJ</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="p">=</span> <span class="n">histc</span><span class="p">(</span><span class="n">un</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="n">cumTrans</span><span class="p">(</span><span class="nb">j</span><span class="p">,:,</span><span class="n">aggIdx</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="n">aggIdx</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))]);</span>
    <span class="n">end</span>
<span class="s">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Mendoza2010/Mendoza2010.html" class="btn btn-neutral float-right" title="Mendoza (2010): Sudden Stops with Asset Price Deflation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../Huggett1997/Huggett1997.html" class="btn btn-neutral float-left" title="Huggett (1997): Steady States and Transition Paths in Heterogeneous Agent Models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Dan Cao, Wenlan Luo, and Guangyu Nie

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>